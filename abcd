import org.json.JSONArray;
import org.json.JSONObject;
import java.util.List;

public class MySubscriptionModel {
    private boolean showAddMoreColumn = false;  // Controls if the "ADD" button column is visible

    public List<LineItem> getMatchingProductIds(List<LineItem> items) {
        LOG.debug("MySubscriptionModel :: getMatchingProductIds :: Start");

        // Mock JSON data for testing
        String jsonData = """
            [
                {"Revenera Product Category": "IPM", "Expiration Date": "25-10-2024"},
                {"Revenera Product Category": "IPM", "Expiration Date": ""},
                {"Revenera Product Category": "", "Expiration Date": "01-01-2023"},
                {"Revenera Product Category": "Non-IPM", "Expiration Date": ""}
            ]
        """;

        // Parse JSON data
        JSONArray jsonArray = new JSONArray(jsonData);

        items.forEach((curItem) -> {
            try {
                String productLineName = curItem.getProductLine().getName();

                // Find JSON object matching the current item's product line name
                JSONObject matchedItem = null;
                for (int i = 0; i < jsonArray.length(); i++) {
                    JSONObject jsonItem = jsonArray.getJSONObject(i);
                    if (jsonItem.getString("Revenera Product Category").equals(productLineName)) {
                        matchedItem = jsonItem;
                        break;
                    }
                }

                // Process matched item based on presence of "Revenera Product Category" and "Expiration Date"
                if (matchedItem != null) {
                    String reveneraProductCategory = matchedItem.getString("Revenera Product Category");
                    String expirationDateStr = matchedItem.getString("Expiration Date");

                    // Check if "Revenera Product Category" has a non-empty value
                    boolean hasNoExpirationDate = (expirationDateStr == null || expirationDateStr.isEmpty());

                    if (reveneraProductCategory != null && !reveneraProductCategory.isEmpty() && hasNoExpirationDate) {
                        // Show "ADD" button if in whitelist and no expiration date
                        curItem.setIsAvailableInWhiteList(true);
                        showAddMoreColumn = true;  // Show "ADD" column if any item is eligible
                        curItem.setStatus("Whitelisted with No Expiration");  // Optional: Set status for display
                    } else {
                        // Hide "ADD" button if not in whitelist or if there is an expiration date
                        curItem.setIsAvailableInWhiteList(false);
                        curItem.setStatus("Not Whitelisted or Has Expiration");
                    }
                } else {
                    curItem.setIsAvailableInWhiteList(false);  // Hide "ADD" button if no match found
                }
            } catch (Exception e) {
                LOG.error("MySubscriptionModel :: getMatchingProductIds :: Error :: {}", e);
            }
        });

        LOG.debug("MySubscriptionModel :: getMatchingProductIds :: End");
        return items;
    }

    // Getter for showAddMoreColumn to be used in frontend template
    public boolean isShowAddMoreColumn() {
        return showAddMoreColumn;
    }
}
